<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEORater</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .table-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f1f1;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background-color: #888;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #555;
        }
        #loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        th[data-sort-key] {
            cursor: pointer;
            user-select: none;
        }
        th[data-sort-key]:hover {
            background-color: #e5e7eb;
        }
        .sort-icon {
            display: inline-block;
            width: 1em;
            margin-left: 0.5rem;
            text-align: center;
            color: #9ca3af;
        }
        th.sorted .sort-icon {
            color: #111827;
        }
        .tsr-cell {
            position: relative;
        }
        .tsr-bar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.2;
        }
        .tsr-bar {
            height: 100%;
        }
        .tsr-text {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-orbitron font-bold italic text-blue-600">CEORater</h1>
            <p class="text-gray-600 mt-2 text-lg">NASDAQ 100 CEO Performance & Compensation Analytics</p>
        </header>

        <main class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
            <!-- Controls: Search and Filters -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <input type="text" id="searchInput"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow md:col-span-1"
                    placeholder="Search by CEO, Company, or Ticker...">
                <select id="industryFilter" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="">All Industries</option>
                </select>
                <select id="sectorFilter" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="">All Sectors</option>
                </select>
            </div>
            <div id="lastUpdated" class="text-xs text-gray-500 text-right mb-6 h-4"></div>


             <!-- Loading Spinner -->
            <div id="loading" class="flex justify-center items-center h-64">
                <div id="loading-spinner"></div>
            </div>

             <!-- Error Message -->
            <div id="error-message" class="hidden text-center text-red-500 font-medium py-8">
                <p>Could not load data from Google Sheets. Please ensure the sheet is published to the web and the link is correct.</p>
            </div>

            <!-- Data Display Area -->
            <div>
                <!-- CEO Table for Desktop -->
                <div class="overflow-x-auto table-scrollbar hidden md:block">
                    <table id="ceoTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="ceo"><div class="flex items-center">CEO <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="tsrValue"><div class="flex items-center">TSR <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="avgAnnualTsr"><div class="flex items-center">Avg. Annual TSR <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="compensation"><div class="flex items-center">Compensation ($MM) <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="compensationCost"><div class="flex items-center">CEO Comp Cost ($MM) / 1% Avg. Ann. TSR <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="tenure"><div class="flex items-center">Tenure (Yrs.) <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="company"><div class="flex items-center">Company <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="ticker"><div class="flex items-center">Ticker <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="industry"><div class="flex items-center">Industry <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider" data-sort-key="sector"><div class="flex items-center">Sector <span class="sort-icon"></span></div></th>
                                <th class="px-6 py-3 text-left align-middle text-xs font-bold text-gray-500 uppercase tracking-wider"><div class="flex items-center">Equity Transactions</div></th>
                            </tr>
                        </thead>
                        <tbody id="ceoTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- CEO Cards for Mobile -->
                <div id="ceoCardView" class="space-y-4 md:hidden">
                    <!-- Cards will be inserted here by JavaScript -->
                </div>

                <p id="noResults" class="text-center text-gray-500 py-8 hidden">No results found.</p>
            </div>
        </main>
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>TSR is Total Stock Return during CEO tenure. CEORater 2025.</p>
        </footer>
    </div>

    <script>
        // Configuration
        const sheetId = '17k06sKH7b8LETZIpGP7nyCC7fmO912pzJQEx1P538CA';
        const sheetGid = '0';
        // Updated range to C6:P107 to include all necessary columns
        const range = 'C6:P107'; 
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}&range=${range}`;
        const REFRESH_INTERVAL_MS = 5 * 60 * 1000; // 5 minutes

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const industryFilter = document.getElementById('industryFilter');
        const sectorFilter = document.getElementById('sectorFilter');
        const lastUpdated = document.getElementById('lastUpdated');
        const ceoTableBody = document.getElementById('ceoTableBody');
        const ceoCardView = document.getElementById('ceoCardView');
        const noResults = document.getElementById('noResults');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');

        // State
        let masterCeoData = [];
        let displayedCeoData = [];
        let currentSort = { key: 'tsrValue', direction: 'desc' };
        let maxAbsTsr = 0;
        
        function parseJSONResponse(text) {
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\((.*)\)/s)[1];
            const data = JSON.parse(jsonString);
            if (!data.table || !data.table.rows) return [];
            
            // Updated column mapping based on the new sheet structure
            return data.table.rows.map(row => {
                // Helper to safely get cell value. Defaults to null if not found.
                const getCellVal = (index, property = 'v') => {
                    const cell = row.c[index];
                    if (cell && cell[property] !== null && typeof cell[property] !== 'undefined') {
                        return cell[property];
                    }
                    return null;
                };

                // Helper to parse numeric values safely, returning 0 if invalid/null.
                const getNumericVal = (index) => {
                    const cell = row.c[index];
                    if (!cell) return 0;

                    // Try to get value from 'v' (raw) or 'f' (formatted) properties
                    let val = cell.v !== null && typeof cell.v !== 'undefined' ? cell.v : cell.f;
                    
                    if (val === null || typeof val === 'undefined') return 0;
                    
                    // If value is a string, remove common non-numeric characters like commas.
                    if (typeof val === 'string') {
                        val = val.replace(/,/g, '').trim();
                    }

                    const num = parseFloat(val);
                    return isNaN(num) ? 0 : num;
                };
                
                return {
                    company: getCellVal(0, 'f') || getCellVal(0) || '', 
                    ticker: getCellVal(1, 'f') || getCellVal(1) || '', 
                    industry: getCellVal(2, 'f') || getCellVal(2) || '',
                    sector: getCellVal(3, 'f') || getCellVal(3) || '', 
                    ceo: getCellVal(5, 'f') || getCellVal(5) || '', 
                    founder: getCellVal(6, 'f') || getCellVal(6) || '',
                    equityTransactions: getCellVal(8, 'f') || getCellVal(8) || '',
                    // New fields parsed explicitly as numbers
                    tenure: getNumericVal(9),
                    compensation: getNumericVal(10),
                    compensationCost: getNumericVal(11),
                    avgAnnualTsr: getNumericVal(12),
                    tsrValue: getNumericVal(13)
                };
            });
        }

        /**
         * Formats a raw decimal value into a percentage string (e.g., 0.25 => "25%")
         * @param {number} value The raw decimal value.
         * @returns {string} A formatted percentage string.
         */
        function formatPercentage(value) {
            if (typeof value !== 'number') return 'N/A';
            const percentage = value * 100;
            return percentage.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }) + '%';
        }
        
        /**
         * Formats a number into a currency string in millions.
         * @param {number} value The number to format.
         * @returns {string} Formatted currency string.
         */
        function formatMillions(value) {
            if (typeof value !== 'number') return 'N/A';
            return value.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function displayData(data) {
            // Clear both views
            ceoTableBody.innerHTML = '';
            ceoCardView.innerHTML = '';

            if (data.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');

            renderTableRows(data);
            renderCards(data);
        }

        function renderTableRows(data) {
             data.forEach(ceo => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                
                const founderBadge = ceo.founder.toUpperCase() === 'Y' 
                    ? `<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Founder</span>` : '';
                
                const filingsLink = ceo.equityTransactions
                    ? `<a href="${ceo.equityTransactions}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">View Filings</a>` : `<span class="text-gray-400">N/A</span>`;

                const tsrBarWidth = maxAbsTsr > 0 ? (Math.abs(ceo.tsrValue) / maxAbsTsr) * 100 : 0;
                const tsrBarColor = ceo.tsrValue >= 0 ? 'bg-green-500' : 'bg-red-500';
                const tsrTextColor = ceo.tsrValue >= 0 ? 'text-green-600' : 'text-red-600';
                const avgTsrTextColor = ceo.avgAnnualTsr >= 0 ? 'text-green-600' : 'text-red-600';

                const tsrBar = `<div class="tsr-bar-container"><div class="tsr-bar ${tsrBarColor}" style="width: ${tsrBarWidth}%"></div></div>`;

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${ceo.ceo}${founderBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm tsr-cell">
                        ${tsrBar}
                        <span class="tsr-text font-bold ${tsrTextColor}">${formatPercentage(ceo.tsrValue)}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${avgTsrTextColor}">${formatPercentage(ceo.avgAnnualTsr)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${formatMillions(ceo.compensation)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${formatMillions(ceo.compensationCost)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ceo.tenure.toFixed(1)}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 whitespace-normal">${ceo.company}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ceo.ticker}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 whitespace-normal">${ceo.industry}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ceo.sector}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${filingsLink}</td>
                `;
                ceoTableBody.appendChild(row);
            });
        }
        
        function renderCards(data) {
            data.forEach(ceo => {
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm';
                
                const founderBadge = ceo.founder.toUpperCase() === 'Y' 
                    ? `<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Founder</span>` : '';

                const filingsLink = ceo.equityTransactions
                    ? `<a href="${ceo.equityTransactions}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">View Filings</a>` : `<span class="text-gray-400">N/A</span>`;
                
                const tsrTextColor = ceo.tsrValue >= 0 ? 'text-green-600' : 'text-red-600';
                const avgTsrTextColor = ceo.avgAnnualTsr >= 0 ? 'text-green-600' : 'text-red-600';

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg text-gray-900">${ceo.ceo}${founderBadge}</h3>
                            <p class="text-sm text-gray-600">${ceo.company} (${ceo.ticker})</p>
                        </div>
                    </div>
                    <div class="mt-4 space-y-2">
                        <div class="flex justify-between text-sm"><span class="font-medium text-gray-500">Total TSR</span><span class="font-bold ${tsrTextColor}">${formatPercentage(ceo.tsrValue)}</span></div>
                        <div class="flex justify-between text-sm"><span class="font-medium text-gray-500">Avg. Annual TSR</span><span class="font-bold ${avgTsrTextColor}">${formatPercentage(ceo.avgAnnualTsr)}</span></div>
                        <div class="flex justify-between text-sm"><span class="font-medium text-gray-500">Compensation ($MM)</span><span class="text-gray-700">$${formatMillions(ceo.compensation)}</span></div>
                        <div class="flex justify-between text-sm text-right"><span class="font-medium text-gray-500">Comp. Cost / 1% TSR ($MM)</span><span class="text-gray-700">$${formatMillions(ceo.compensationCost)}</span></div>
                        <div class="flex justify-between text-sm"><span class="font-medium text-gray-500">Tenure (Yrs.)</span><span class="text-gray-700">${ceo.tenure.toFixed(1)}</span></div>
                        <div class="flex justify-between text-sm"><span class="font-medium text-gray-500">Industry</span><span class="text-gray-700 text-right">${ceo.industry}</span></div>
                        <div class="flex justify-between text-sm"><span class="font-medium text-gray-500">Sector</span><span class="text-gray-700 text-right">${ceo.sector}</span></div>
                        <div class="flex justify-between text-sm items-center pt-2 border-t"><span class="font-medium text-gray-500">Equity Transactions</span><span>${filingsLink}</span></div>
                    </div>
                `;
                ceoCardView.appendChild(card);
            });
        }

        function sortData() {
            const { key, direction } = currentSort;
            // Sorting logic now handles all keys, assuming they are either numbers or strings.
            displayedCeoData.sort((a, b) => {
                const valA = a[key];
                const valB = b[key];
                
                let comparison = 0;
                if (typeof valA === 'number' && typeof valB === 'number') {
                    comparison = valA - valB;
                } else {
                    comparison = String(valA).localeCompare(String(valB), 'en', { sensitivity: 'base' });
                }
                
                return direction === 'asc' ? comparison : -comparison;
            });
            updateSortIcons();
            displayData(displayedCeoData);
        }

        function updateSortIcons() {
            document.querySelectorAll('th[data-sort-key]').forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                if (th.dataset.sortKey === currentSort.key) {
                    th.classList.add('sorted');
                    icon.textContent = currentSort.direction === 'asc' ? '▲' : '▼';
                } else {
                    icon.textContent = ' '; // Use a space to maintain alignment
                }
            });
        }
        
        function handleSort(e) {
            const key = e.currentTarget.dataset.sortKey;
            if (!key) return;
            if (currentSort.key === key) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                // Default sort direction for numeric columns.
                const numericKeys = ['tsrValue', 'avgAnnualTsr', 'compensation', 'compensationCost', 'tenure'];
                currentSort.direction = numericKeys.includes(key) ? 'desc' : 'asc';
            }
            sortData();
        }

        function filterData() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedIndustry = industryFilter.value;
            const selectedSector = sectorFilter.value;

            displayedCeoData = masterCeoData.filter(ceo => {
                const searchMatch = (ceo.ceo && ceo.ceo.toLowerCase().includes(searchTerm)) ||
                       (ceo.company && ceo.company.toLowerCase().includes(searchTerm)) ||
                       (ceo.ticker && ceo.ticker.toLowerCase().includes(searchTerm));
                const industryMatch = !selectedIndustry || ceo.industry === selectedIndustry;
                const sectorMatch = !selectedSector || ceo.sector === selectedSector;
                return searchMatch && industryMatch && sectorMatch;
            });
            sortData();
        }

        function populateFilters(data) {
            const industries = [...new Set(data.map(ceo => ceo.industry).filter(Boolean))].sort();
            const sectors = [...new Set(data.map(ceo => ceo.sector).filter(Boolean))].sort();

            industryFilter.innerHTML = '<option value="">All Industries</option>';
            industries.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                industryFilter.appendChild(option);
            });

            sectorFilter.innerHTML = '<option value="">All Sectors</option>';
            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorFilter.appendChild(option);
            });
        }
        
        async function fetchAndUpdateData(isInitialLoad = false) {
             try {
                const response = await fetch(`${sheetUrl}&t=${new Date().getTime()}`); // Cache-busting
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const responseText = await response.text();
                masterCeoData = parseJSONResponse(responseText);

                if (masterCeoData.length === 0) {
                   if (isInitialLoad) throw new Error("No data parsed from the sheet.");
                   return; // On subsequent refreshes, just exit without error if data is empty
                }

                // Calculate max TSR for bar visualization
                maxAbsTsr = Math.max(...masterCeoData.map(ceo => Math.abs(ceo.tsrValue)));
                
                if (isInitialLoad) {
                    populateFilters(masterCeoData);
                }
                
                filterData(); // This will also call sortData and displayData
                
                const now = new Date();
                lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;

            } catch (error) {
                console.error("Error fetching or processing data: ", error);
                if (isInitialLoad) errorMessage.classList.remove('hidden');
            } finally {
                if (isInitialLoad) loading.style.display = 'none';
            }
        }

        async function init() {
            await fetchAndUpdateData(true);
            searchInput.addEventListener('input', filterData);
            industryFilter.addEventListener('change', filterData);
            sectorFilter.addEventListener('change', filterData);
            document.querySelectorAll('th[data-sort-key]').forEach(th => th.addEventListener('click', handleSort));
            setInterval(() => fetchAndUpdateData(false), REFRESH_INTERVAL_MS);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
