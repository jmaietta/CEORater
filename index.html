<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ====== Meta / Icons ====== -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CEORater</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <meta property="og:title" content="CEORater">
  <meta property="og:description" content="NASDAQ 100 CEO Performance & Compensation Analytics" />
  <meta property="og:image" content="https://www.ceorater.com/android-chrome-512x512.png" />
  <meta property="og:url" content="https://www.ceorater.com/" />

  <!-- ====== Tailwind & Fonts ====== -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .font-orbitron { font-family: 'Orbitron', sans-serif; }
    #loading-spinner{border:4px solid rgba(0,0,0,.1);width:36px;height:36px;border-radius:50%;border-left-color:#09f;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4 md:p-8">
    <!-- ===== Auth / Watchlist bar ===== -->
    <nav class="flex justify-end gap-3 mb-4">
      <a id="watchlistLink" href="#" class="hidden text-blue-600 hover:underline">My Watchlist</a>
      <button id="loginBtn"  class="px-3 py-1 bg-blue-600 text-white rounded-lg">Log in</button>
      <button id="logoutBtn" class="hidden px-3 py-1 border rounded-lg">Log out</button>
    </nav>

    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-orbitron italic font-bold text-blue-600">CEORater</h1>
      <p class="text-gray-600 mt-2 text-lg">NASDAQ 100 CEO Performance & Compensation Analytics</p>
    </header>

    <!-- ===== Main Card ===== -->
    <main class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
      <!-- Filters -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <input id="searchInput" type="text" placeholder="Search by CEO, Company, or Ticker." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" />
        <select id="industryFilter" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white"></select>
        <select id="sectorFilter"   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white"></select>
        <select id="sortControl"    class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white">
          <option value="tsrValue-desc">Sort: TSR ↓</option>
          <option value="tsrValue-asc">Sort: TSR ↑</option>
          <option value="avgAnnualTsr-desc">Avg Annual TSR ↓</option>
          <option value="avgAnnualTsr-asc">Avg Annual TSR ↑</option>
          <option value="compensation-desc">Compensation ↓</option>
          <option value="compensation-asc">Compensation ↑</option>
          <option value="tenure-desc">Tenure ↓</option>
          <option value="tenure-asc">Tenure ↑</option>
          <option value="ceo-asc">CEO A‑Z</option>
          <option value="ceo-desc">CEO Z‑A</option>
          <option value="company-asc">Company A‑Z</option>
          <option value="company-desc">Company Z‑A</option>
        </select>
      </div>

      <div class="flex justify-end mb-4">
        <button id="downloadExcelButton" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Export to Excel</button>
      </div>

      <div id="lastUpdated" class="text-xs text-gray-500 text-right mb-4 h-4"></div>
      <div id="loading" class="flex justify-center items-center h-64"><div id="loading-spinner"></div></div>
      <div id="error-message" class="hidden text-center text-red-500 py-8">Could not load data from Google Sheets.</div>

      <div>
        <div id="ceoCardView" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
        <p id="noResults" class="hidden text-center text-gray-500 py-8">No results found.</p>
      </div>
    </main>

    <footer class="text-center mt-8 text-sm text-gray-500">TSR is Total Stock Return during CEO tenure · CEORater 2025</footer>
  </div>

  <!-- ======= Core UI / Google‑Sheets loader ======= -->
  <script>
    // ---------- Google Sheet Config ----------
    const sheetId   = '17k06sKH7b8LETZIpGP7nyCC7fmO912pzJQEx1P538CA';
    const sheetGid  = '0';
    const range     = 'C6:S107';
    const sheetUrl  = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}&range=${range}`;
    const REFRESH   = 5 * 60 * 1000; // 5 min

    // ---------- DOM ----------
    const $ = id=>document.getElementById(id);
    const searchInput  = $("searchInput");
    const industryFilter=$("industryFilter");
    const sectorFilter =$("sectorFilter");
    const sortControl  =$("sortControl");
    const lastUpdated  =$("lastUpdated");
    const ceoCardView  =$("ceoCardView");
    const noResults    =$("noResults");
    const loading      =$("loading");
    const errorMessage =$("error-message");

    // ---------- State ----------
    let master = [];
    let view   = [];
    let currentSort = { key:'tsrValue', dir:'desc' };

    // ---------- Helpers ----------
    const pct = v=> typeof v==='number'? (v*100).toLocaleString('en-US',{maximumFractionDigits:0})+'%':'N/A';
    const money=(v,d=2)=> typeof v==='number'? v.toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d}):'N/A';

    function parseRows(txt){
      const m = txt.match(/google\.visualization\.Query\.setResponse\((.*)\)/s);
      if(!m) return [];
      const data = JSON.parse(m[1]);
      if(!data.table?.rows) return [];
      return data.table.rows.map(r=>{
        const gv=(i)=>{const c=r.c[i];return c&&c.v!=null?c.v:""};
        const gn=(i)=>{const c=r.c[i];if(!c) return 0;return parseFloat((c.v??c.f??"0").toString().replace(/[^\d.-]/g,''))||0};
        return {
          company: gv(0), ticker: gv(1), industry: gv(2), sector: gv(3),
          ceo: gv(5), founder: gv(6), compensation: gn(7), equityTransactions: gv(8),
          tsrValue: gn(13), tenure: gn(14), avgAnnualTsr: gn(15), compensationCost: gn(16)
        };
      });
    }

    function renderCards(data){
      ceoCardView.innerHTML='';
      data.forEach(c=>{
        const saved = cachedWatchlist.has(c.ticker);
        const card=document.createElement('div');
        card.className='bg-white border border-gray-200 rounded-lg p-4 shadow-sm flex flex-col justify-between';
        const founder = (c.founder?.toUpperCase()==='Y')?'<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Founder</span>':'';
        const filings = c.equityTransactions?`<a href="${c.equityTransactions}" target="_blank" class="text-blue-600 hover:underline">View Filings</a>`:'<span class="text-gray-400">N/A</span>';
        const tsrCol  = c.tsrValue>=0?'text-green-600':'text-red-600';
        const avgCol  = c.avgAnnualTsr>=0?'text-green-600':'text-red-600';
        card.innerHTML=`
          <div>
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-bold text-lg text-gray-900">${c.ceo}${founder}</h3>
                <p class="text-sm text-gray-600">${c.company} (${c.ticker})</p>
              </div>
              <button data-ticker="${c.ticker}" title="${saved?'Remove':'Add'} watchlist" class="text-xl ${saved?'text-yellow-400':'text-gray-300'}">${saved?'★':'☆'}</button>
            </div>
            <div class="mt-4 space-y-2 text-sm">
              <div class="flex justify-between"><span class="text-gray-500">TSR During Tenure</span><span class="font-bold ${tsrCol}">${pct(c.tsrValue)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Avg Annual TSR</span><span class="font-bold ${avgCol}">${pct(c.avgAnnualTsr)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">CEO Compensation ($MM)</span><span>$${money(c.compensation,1)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Comp Cost / 1% Avg TSR ($MM)</span><span>$${money(c.compensationCost,3)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Tenure (yrs)</span><span>${c.tenure.toFixed(1)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Industry</span><span>${c.industry||'N/A'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Sector</span><span>${c.sector||'N/A'}</span></div>
            </div>
          </div>
          <div class="flex justify-between text-sm items-center pt-3 mt-3 border-t"><span class="text-gray-500">Equity Transactions</span><span>${filings}</span></div>`;
        ceoCardView.appendChild(card);
      });
    }

    function refreshFilters(){
      const inds=[...new Set(master.map(c=>c.industry).filter(Boolean))].sort();
      const secs=[...new Set(master.map(c=>c.sector).filter(Boolean))].sort();
      industryFilter.innerHTML='<option value="">All Industries</option>'+inds.map(i=>`<option>${i}</option>`).join('');
      sectorFilter.innerHTML  ='<option value="">All Sectors</option>'+secs.map(s=>`<option>${s}</option>`).join('');
    }

    function applyFilters(){
      const term=searchInput.value.toLowerCase();
      const ind =industryFilter.value;
      const sec =sectorFilter.value;
      view = master.filter(c=>{
        const matchTerm=(c.ceo+c.company+c.ticker).toLowerCase().includes(term);
        const matchInd =!ind||c.industry===ind;
        const matchSec =!sec||c.sector===sec;
        return matchTerm&&matchInd&&matchSec;
      });
      sortAndRender();
    }

    function sortAndRender(){
      view.sort((a,b)=>{
        const A=a[currentSort.key];
        const B=b[currentSort.key];
        let cmp=(typeof A==='number'&&typeof B==='number')?A-B:String(A).localeCompare(String(B));
        return currentSort.dir==='asc'?cmp:-cmp;
      });
      if(view.length===0) noResults.classList.remove('hidden'); else noResults.classList.add('hidden');
      renderCards(view);
    }

    function fetchData(initial){
      fetch(sheetUrl+`&t=${Date.now()}`)
        .then(r=>r.text())
        .then(txt=>{
          master=parseRows(txt);
          if(initial) refreshFilters();
          applyFilters();
          lastUpdated.textContent='Last updated: '+new Date().toLocaleTimeString();
        })
        .catch(()=> initial && errorMessage.classList.remove('hidden'))
        .finally(()=> initial && (loading.style.display='none'));
    }

    function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

    // Event wiring
    document.addEventListener('DOMContentLoaded',()=>{
      fetchData(true);
      setInterval(()=>fetchData(false),REFRESH);
      searchInput.addEventListener('input',debounce(applyFilters,300));
      industryFilter.addEventListener('change',applyFilters);
      sectorFilter.addEventListener('change',applyFilters);
      sortControl.addEventListener('change',e=>{const [k,d]=e.target.value.split('-');currentSort={key:k,dir:d};sortAndRender();});
      $("download
