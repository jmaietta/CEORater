<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CEORater</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

  <!-- Social -->
  <meta property="og:title" content="CEORater">
  <meta property="og:description" content="NASDAQ 100 CEO Performance & Compensation Analytics">
  <meta property="og:image" content="https://www.ceorater.com/android-chrome-512x512.png">
  <meta property="og:url" content="https://www.ceorater.com/">

  <!-- Tailwind & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Inter',sans-serif;}
    .font-orbitron{font-family:'Orbitron',sans-serif;}
    #loading-spinner{border:4px solid rgba(0,0,0,.1);width:36px;height:36px;border-radius:50%;border-left-color:#09f;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4 md:p-8">

    <!-- Auth / Watchlist -->
    <nav class="flex justify-end gap-3 mb-4">
      <a id="watchlistLink" href="#" class="hidden text-blue-600 hover:underline">My Watchlist</a>
      <button id="loginBtn"  class="px-3 py-1 bg-blue-600 text-white rounded-lg">Log in</button>
      <button id="logoutBtn" class="hidden px-3 py-1 border rounded-lg">Log out</button>
    </nav>

    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-orbitron italic font-bold text-blue-600">CEORater</h1>
      <p class="text-gray-600 mt-2 text-lg">NASDAQ 100 CEO Performance & Compensation Analytics</p>
    </header>

    <main class="bg-white rounded-xl shadow-lg p-4 sm:p-6">

      <!-- Filters -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <input id="searchInput" type="text" placeholder="Search CEO, Company, or Ticker" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
        <select id="industryFilter" class="w-full px-4 py-3 border rounded-lg bg-white"></select>
        <select id="sectorFilter"   class="w-full px-4 py-3 border rounded-lg bg-white"></select>
        <select id="sortControl"    class="w-full px-4 py-3 border rounded-lg bg-white">
          <option value="tsrValue-desc">Sort: TSR ↓</option>
          <option value="tsrValue-asc">Sort: TSR ↑</option>
          <option value="avgAnnualTsr-desc">Avg Annual TSR ↓</option>
          <option value="avgAnnualTsr-asc">Avg Annual TSR ↑</option>
          <option value="compensation-desc">Compensation ↓</option>
          <option value="compensation-asc">Compensation ↑</option>
          <option value="tenure-desc">Tenure ↓</option>
          <option value="tenure-asc">Tenure ↑</option>
          <option value="ceo-asc">CEO A‑Z</option>
          <option value="ceo-desc">CEO Z‑A</option>
          <option value="company-asc">Company A‑Z</option>
          <option value="company-desc">Company Z‑A</option>
        </select>
      </div>

      <!-- Export -->
      <div class="flex justify-end mb-4">
        <button id="downloadCsvBtn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Export CSV</button>
      </div>

      <div id="lastUpdated" class="text-xs text-gray-500 text-right mb-4 h-4"></div>
      <div id="loading" class="flex justify-center items-center h-64"><div id="loading-spinner"></div></div>
      <div id="error-message" class="hidden text-center text-red-500 py-8">Could not load data from Google Sheets.</div>

      <div>
        <div id="ceoCardView" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
        <p id="noResults" class="hidden text-center text-gray-500 py-8">No results found.</p>
      </div>
    </main>

    <footer class="text-center mt-8 text-sm text-gray-500">TSR = Total Stock Return during CEO tenure · CEORater 2025</footer>
  </div>

  <!-- === Google Sheets === -->
  <script>
    const sheetId='17k06sKH7b8LETZIpGP7nyCC7fmO912pzJQEx1P538CA';
    const sheetGid='0';
    const range='C6:S107';
    const sheetUrl=\`https://docs.google.com/spreadsheets/d/\${sheetId}/gviz/tq?tqx=out:json&gid=\${sheetGid}&range=\${range}\`;
    const REFRESH=5*60*1000; // 5 min

    const $=id=>document.getElementById(id);
    const searchInput=$('searchInput'),industryFilter=$('industryFilter'),sectorFilter=$('sectorFilter'),sortControl=$('sortControl');
    const lastUpdated=$('lastUpdated'),ceoCardView=$('ceoCardView'),noResults=$('noResults'),loading=$('loading'),errorMessage=$('error-message');
    const downloadBtn=$('downloadCsvBtn');

    let master=[],view=[],currentSort={key:'tsrValue',dir:'desc'};
    window.cachedWatchlist=new Set();

    const pct=v=>typeof v==='number'?(v*100).toLocaleString('en-US',{maximumFractionDigits:0})+'%':'N/A';
    const money=(v,d=2)=>typeof v==='number'?v.toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d}):'N/A';

    function parseRows(txt){
      const m=txt.match(/google\\.visualization\\.Query\\.setResponse\\((.*)\\)/s);
      if(!m)return[];
      const d=JSON.parse(m[1]);
      if(!d.table?.rows)return[];
      return d.table.rows.map(r=>{
        const gv=i=>{const c=r.c[i];return c&&c.v!=null?c.v:''};
        const gn=i=>{const c=r.c[i];if(!c)return 0;return parseFloat((c.v??c.f??'0').toString().replace(/[^\\d.-]/g,''))||0};
        return{company:gv(0),ticker:gv(1),industry:gv(2),sector:gv(3),ceo:gv(5),founder:gv(6),compensation:gn(7),equityTransactions:gv(8),tsrValue:gn(13),tenure:gn(14),avgAnnualTsr:gn(15),compensationCost:gn(16)};
      });
    }

    function renderCards(data){
      ceoCardView.innerHTML='';
      data.forEach(c=>{
        const saved=window.cachedWatchlist.has(c.ticker);
        const card=document.createElement('div');
        card.className='bg-white border border-gray-200 rounded-lg p-4 shadow-sm flex flex-col justify-between';
        const founder=c.founder?.toUpperCase()==='Y'?'<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Founder</span>':'';
        const filings=c.equityTransactions?`<a href="${c.equityTransactions}" target="_blank" class="text-blue-600 hover:underline">View Filings</a>`:'<span class="text-gray-400">N/A</span>';
        const tsrCol=c.tsrValue>=0?'text-green-600':'text-red-600';
        const avgCol=c.avgAnnualTsr>=0?'text-green-600':'text-red-600';
        card.innerHTML=\`
          <div>
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-bold text-lg text-gray-900">\${c.ceo}\${founder}</h3>
                <p class="text-sm text-gray-600">\${c.company} (\${c.ticker})</p>
              </div>
              <button data-ticker="\${c.ticker}" title="\${saved?'Remove':'Add'} watchlist" class="text-xl \${saved?'text-yellow-400':'text-gray-300'}">\${saved?'★':'☆'}</button>
            </div>
            <div class="mt-4 space-y-2 text-sm">
              <div class="flex justify-between"><span class="text-gray-500">TSR During Tenure</span><span class="font-bold \${tsrCol}">\${pct(c.tsrValue)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Avg Annual TSR</span><span class="font-bold \${avgCol}">\${pct(c.avgAnnualTsr)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">CEO Compensation ($MM)</span><span>$\${money(c.compensation,1)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Comp Cost / 1% Avg TSR ($MM)</span><span>$\${money(c.compensationCost,3)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Tenure (yrs)</span><span>\${c.tenure.toFixed(1)}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Industry</span><span>\${c.industry||'N/A'}</span></div>
              <div class="flex justify-between"><span class="text-gray-500">Sector</span><span>\${c.sector||'N/A'}</span></div>
            </div>
          </div>
          <div class="flex justify-between text-sm items-center pt-3 mt-3 border-t">
            <span class="text-gray-500">Equity Transactions</span><span>\${filings}</span>
          </div>\`;
        ceoCardView.appendChild(card);
      });
    }

    function refreshFilters(){
      const inds=[...new Set(master.map(c=>c.industry).filter(Boolean))].sort();
      const secs=[...new Set(master.map(c=>c.sector).filter(Boolean))].sort();
      industryFilter.innerHTML='<option value=\"\">All Industries</option>'+inds.map(i=>`<option>\${i}</option>`).join('');
      sectorFilter.innerHTML='<option value=\"\">All Sectors</option>'+secs.map(s=>`<option>\${s}</option>`).join('');
    }

    function applyFilters(){
      const term=searchInput.value.toLowerCase();
      const ind=industryFilter.value;
      const sec=sectorFilter.value;
      view=master.filter(c=>{
        const tMatch=(c.ceo+c.company+c.ticker).toLowerCase().includes(term);
        const iMatch=!ind||c.industry===ind;
        const sMatch=!sec||c.sector===sec;
        return tMatch&&iMatch&&sMatch;
      });
      sortAndRender();
    }

    function sortAndRender(){
      view.sort((a,b)=>{
        const A=a[currentSort.key],B=b[currentSort.key];
        let cmp=(typeof A==='number'&&typeof B==='number')?A-B:String(A).localeCompare(String(B));
        return currentSort.dir==='asc'?cmp:-cmp;
      });
      noResults.classList.toggle('hidden',view.length>0);
      renderCards(view);
    }

    function fetchData(init){
      fetch(sheetUrl+`&t=\${Date.now()}`)
        .then(r=>r.text())
        .then(txt=>{
          master=parseRows(txt);
          if(init)refreshFilters();
          applyFilters();
          lastUpdated.textContent='Last updated: '+new Date().toLocaleTimeString();
        })
        .catch(()=>init&&errorMessage.classList.remove('hidden'))
        .finally(()=>init&&(loading.style.display='none'));
    }

    function exportCsv(filename,data){
      const headers=[\"CEO\",\"Company\",\"Ticker\",\"Founder\",\"Tenure\",\"TSR\",\"Avg Annual TSR\",\"Compensation\",\"Comp Cost/1%\",\"Industry\",\"Sector\"];
      const rows=data.map(c=>[
        c.ceo,c.company,c.ticker,c.founder,c.tenure.toFixed(1),pct(c.tsrValue),pct(c.avgAnnualTsr),
        '$'+money(c.compensation,1),'$'+money(c.compensationCost,3),c.industry,c.sector
      ].map(v=>`\"\${String(v).replace(/\"/g,'\"\"')}\"`).join(','));
      const csv=[headers.join(',')].concat(rows).join('\\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=filename;
      a.click();
    }

    // Debounce helper
    function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

    document.addEventListener('DOMContentLoaded',()=>{
      fetchData(true);
      setInterval(()=>fetchData(false),REFRESH);
      searchInput.addEventListener('input',debounce(applyFilters,300));
      industryFilter.addEventListener('change',applyFilters);
      sectorFilter.addEventListener('change',applyFilters);
      sortControl.addEventListener('change',e=>{const[k,d]=e.target.value.split('-');currentSort={key:k,dir:d};sortAndRender();});
      downloadBtn.addEventListener('click',()=>exportCsv('CEORater.csv',view));
    });
  </script>

  <!-- === Firebase Auth + Watchlist === -->
  <script type="module">
    import { initializeApp } from \"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js\";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from \"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js\";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from \"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js\";

    const firebaseConfig={
      apiKey:            import.meta.env.VITE_FB_API_KEY,
      authDomain:        import.meta.env.VITE_FB_AUTH_DOMAIN,
      projectId:         import.meta.env.VITE_FB_PROJECT_ID,
      storageBucket:     import.meta.env.VITE_FB_STORAGE_BUCKET,
      messagingSenderId: import.meta.env.VITE_FB_MESSAGING_SENDER_ID,
      appId:             import.meta.env.VITE_FB_APP_ID,
      measurementId:     import.meta.env.VITE_FB_MEASUREMENT_ID
    };

    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);

    const loginBtn=document.getElementById('loginBtn');
    const logoutBtn=document.getElementById('logoutBtn');
    const watchlistLink=document.getElementById('watchlistLink');

    let currentUser=null;

    loginBtn.addEventListener('click',async()=>{
      const provider=new GoogleAuthProvider();
      await signInWithPopup(auth,provider);
    });

    logoutBtn.addEventListener('click',()=>signOut(auth));

    function loadWatchlist(){
      const q=collection(db,`users/\${currentUser.uid}/watchlist`);
      onSnapshot(q,snap=>{
        window.cachedWatchlist=new Set(snap.docs.map(d=>d.id));
        renderCards(view);
      });
    }

    async function toggleWatch(tkr){
      if(!currentUser){loginBtn.click();return;}
      const ref=doc(db,'users',currentUser.uid,'watchlist',tkr);
      if(window.cachedWatchlist.has(tkr)) await deleteDoc(ref);
      else await setDoc(ref,{added:Date.now()});
    }

    onAuthStateChanged(auth,user=>{
      currentUser=user;
      loginBtn.classList.toggle('hidden',!!user);
      logoutBtn.classList.toggle('hidden',!user);
      watchlistLink.classList.toggle('hidden',!user);
      if(user) loadWatchlist(); else {window.cachedWatchlist=new Set(); renderCards(view);}
    });

    document.getElementById('ceoCardView').addEventListener('click',e=>{
      if(e.target.matches('button[data-ticker]')) toggleWatch(e.target.dataset.ticker);
    });

    watchlistLink.addEventListener('click',e=>{
      e.preventDefault();
      industryFilter.value=sectorFilter.value='';
      searchInput.value='';
      view=master.filter(c=>window.cachedWatchlist.has(c.ticker));
      sortAndRender();
    });
  </script>
</body>
</html>

