// admin_app.jsx – CEORater Admin Dashboard (rewritten & sanitised)
// -----------------------------------------------------------------
// • No double‑slash URLs (API_BASE_URL has *no* trailing '/')
// • Stable API_BASE_URL is a module constant so React deps stay clean
// • apiFetch guards 204 vs JSON, surfs auth redirects, shows messages
// • Robust numeric / date parsing – prevents NaN → toFixed() crashes
// • YouTube URLs parsed safely; modal is a React component (no raw DOM)
// • New‑row placeholder uses a unique key to silence React warnings
// • Minimal Tailwind classes; replace with your CSS if you prefer.

import React, { useState, useEffect, useCallback } from "react";

/* ---------- Config ---------- */
export const API_BASE_URL =
  import.meta.env.VITE_CEORATER_API ||
  process.env.REACT_APP_CEORATER_API ||
  "https://ceorater-backend.onrender.com"; // <-- fallback

/* Helper to build absolute URLs */
const apiUrl = (path) =>
  path.startsWith("http") ? path : `${API_BASE_URL}${path.startsWith("/") ? "" : "/"}${path}`;

/* ---------- Re‑usable util ---------- */
const parsePct = (val) => {
  const n = parseFloat(String(val).replace(/[%+,]/g, ""));
  return Number.isFinite(n) ? n : null;
};

const safeJsonParse = (str, fallback = []) => {
  try {
    return JSON.parse(str || "[]");
  } catch {
    return fallback;
  }
};

const tenureString = (start) => {
  if (!start) return "N/A";
  const s = new Date(start);
  if (isNaN(s)) return "N/A";
  const now = new Date();
  let yrs = now.getFullYear() - s.getFullYear();
  let mos = now.getMonth() - s.getMonth();
  if (mos < 0) {
    yrs -= 1;
    mos += 12;
  }
  return `${yrs} yrs, ${mos} mo`;
};

/* ---------- Main component ---------- */
export default function AdminApp() {
  /* ----- state ----- */
  const [loggedIn, setLoggedIn]       = useState(false);
  const [ceos, setCeos]               = useState([]);
  const [error, setError]             = useState("");
  const [addingNew, setAddingNew]     = useState(false);
  const [editingId, setEditingId]     = useState(null);
  const [videoUrls, setVideoUrls]     = useState(null); // opens modal when not null

  /* ----- error helpers ----- */
  const showError = (msg) => setError(msg);
  const clearError = () => setError("");

  /* ----- generic fetch wrapper ----- */
  const apiFetch = useCallback(async (path, opts = {}) => {
    const options = {
      credentials: "include",
      headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
      ...opts,
    };
    const res = await fetch(apiUrl(path), options);

    if (res.status === 401 || res.status === 403) {
      window.location.href = apiUrl("/admin/auth/google");
      throw new Error("Unauthorized");
    }
    if (!res.ok) throw new Error((await res.text()) || `HTTP ${res.status}`);
    return res.status === 204 ? null : res.json();
  }, []);

  /* ----- auth check & initial load ----- */
  useEffect(() => {
    (async () => {
      try {
        const { loggedIn: ok } = await apiFetch("/admin/auth/status");
        if (ok) {
          setLoggedIn(true);
          loadCeos();
        }
      } catch (e) {
        setLoggedIn(false);
        if (e.message !== "Unauthorized") showError(e.message);
      }
    })();
  }, [apiFetch]);

  /* ----- load CEO list ----- */
  const loadCeos = useCallback(async () => {
    clearError();
    try {
      const arr = await apiFetch("/admin/ceos");
      arr.sort((a, b) => (a.ceo_name || "").localeCompare(b.ceo_name || ""));
      setCeos(arr);
    } catch (e) {
      showError(`Failed to load CEOs: ${e.message}`);
    }
  }, [apiFetch]);

  /* ----- logout ----- */
  const handleLogout = async () => {
    clearError();
    try {
      await apiFetch("/admin/auth/logout", { method: "POST" });
    } catch (e) {
      /* ignore */
    } finally {
      setLoggedIn(false);
      window.location.href = apiUrl("/admin/auth/google");
    }
  };

  /* ---------- row helpers ---------- */
  const beginAddRow = () => {
    if (addingNew) return showError("Finish the current new row first.");
    clearError();
    setAddingNew(true);
    setCeos((prev) => [
      { id: `tmp-${Date.now()}`, isNew: true },
      ...prev,
    ]);
  };

  const cancelEdit = () => {
    setEditingId(null);
    if (addingNew) setCeos((prev) => prev.filter((c) => !c.isNew));
    setAddingNew(false);
  };

  const saveRow = async (id, data) => {
    clearError();
    const required = ["ceo_name", "company_name", "ticker", "stock_price_on_start"];
    if (required.some((k) => !data[k]))
      return showError("Please fill all required fields.");
    if (data.ceo_start_date && !/^\d{4}-\d{2}-\d{2}$/.test(data.ceo_start_date))
      return showError("Start date must be YYYY-MM-DD.");
    try {
      if (id.startsWith("tmp-")) {
        await apiFetch("/admin/ceos", { method: "POST", body: JSON.stringify(data) });
        setAddingNew(false);
      } else {
        await apiFetch(`/admin/ceos/${id}`, { method: "PUT", body: JSON.stringify(data) });
      }
      setEditingId(null);
      loadCeos();
    } catch (e) {
      showError(e.message);
    }
  };

  const deleteRow = async (id) => {
    clearError();
    if (!window.confirm("Delete this CEO?")) return;
    try {
      await apiFetch(`/admin/ceos/${id}`, { method: "DELETE" });
      loadCeos();
    } catch (e) {
      showError(e.message);
    }
  };

  /* ---------- Row component ---------- */
  const CeoRow = ({ ceo }) => {
    const isEditing = editingId === ceo.id;
    const [row, setRow] = useState(
      ceo.isNew
        ? {
            ceo_name: "",
            company_name: "",
            ticker: "",
            founder: "N",
            ceo_start_date: "",
            ceo_compensation_mm: "",
            equity_ownership_url: "",
            stock_price_on_start: "",
            industry: "",
            sector: "",
            youtube_urls: "[]",
          }
        : { ...ceo }
    );

    const onChange = (e) => {
      const { name, value, type } = e.target;
      setRow((p) => ({ ...p, [name]: type === "number" ? Number(value) : value }));
    };

    const tenure = tenureString(row.ceo_start_date);
    const returnPct = row.total_stock_return != null ? `${row.total_stock_return.toFixed(2)}%` : "N/A";
    const compFmt = row.ceo_compensation_mm != null ? `$${Number(row.ceo_compensation_mm).toFixed(2)} MM` : "N/A";
    const priceStartFmt = row.stock_price_on_start != null ? `$${Number(row.stock_price_on_start).toFixed(2)}` : "N/A";
    const priceCurrentFmt = row.current_stock_price != null ? `$${Number(row.current_stock_price).toFixed(2)}` : "N/A";
    const ytLinks = safeJsonParse(row.youtube_urls);

    return (
      <tr>
        {/* CEO Name */}
        <td>{isEditing ? <input name="ceo_name" value={row.ceo_name} onChange={onChange} required /> : row.ceo_name || "N/A"}</td>
        {/* Company */}
        <td>{isEditing ? <input name="company_name" value={row.company_name} onChange={onChange} required /> : row.company_name || "N/A"}</td>
        {/* Ticker */}
        <td>{isEditing ? <input name="ticker" value={row.ticker} onChange={onChange} required /> : row.ticker || "N/A"}</td>
        {/* Founder */}
        <td>
          {isEditing ? (
            <select name="founder" value={row.founder} onChange={onChange}>
              <option value="N">N</option>
              <option value="Y">Y</option>
            </select>
          ) : (
            row.founder || "N/A"
          )}
        </td>
        {/* Tenure */}
        <td>{isEditing ? <input name="ceo_start_date" type="date" value={row.ceo_start_date} onChange={onChange} /> : tenure}</td>
        {/* Return */}
        <td>{returnPct}</td>
        {/* Comp */}
        <td>
          {isEditing ? (
            <input name="ceo_compensation_mm" type="number" step="0.01" value={row.ceo_compensation_mm} onChange={onChange} />
          ) : (
            compFmt
          )}
        </td>
        {/* Equity URL */}
        <td>
          {isEditing ? (
            <input name="equity_ownership_url" value={row.equity_ownership_url} onChange={onChange} />
          ) : row.equity_ownership_url ? (
            <a href={row.equity_ownership_url} target="_blank" rel="noreferrer">View</a>
          ) : "N/A"}
        </td>
        {/* Prices */}
        <td>{isEditing ? <input name="stock_price_on_start" type="number" step="0.01" value={row.stock_price_on_start} onChange={onChange} /> : priceStartFmt}</td>
        <td>{priceCurrentFmt}</td>
        {/* YouTube */}
        <td>
          {isEditing ? (
            <input
              name="youtube_urls"
              value={ytLinks.join(", ")}
              onChange={(e) => setRow((p) => ({ ...p, youtube_urls: JSON.stringify(e.target.value.split(",").map((u) => u.trim())) }))}
            />
          ) : ytLinks.length ? (
            <button className="text-blue-600 underline" onClick={() => setVideoUrls(ytLinks)}>
              Videos ({ytLinks.length})
            </button>
          ) : (
            "N/A"
          )}
        </td>
        {/* Actions */}
        <td>
          {isEditing ? (
            <>
              <button className="text-green-600 mr-2" onClick={() => saveRow(ceo.id, row)}>Save</button>
              <button className="text-gray-500" onClick={cancelEdit}>Cancel</button>
            </>
          ) : (
            <>
              <button className="text-blue-600 mr-2" onClick={() => setEditingId(ceo.id)}>Edit</button>
              <button className="text-red-600" onClick={() => deleteRow(ceo.id)}>Delete</button>
            </>
          )}
        </td>
      </tr>
    );
  };

  /* ---------- Modal component ---------- */
  const VideoModal = ({ urls }) => (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
      <div className="bg-white p-6 rounded max-w-md w-full">
        <h3 className="text-lg font-semibold mb-4">YouTube Videos</h3>
        <ul className="space-y-2 mb-4">
          {urls.map((u, i) => (
            <li key={i}>
              <a className="text-blue-600 underline" href={u} target="_blank" rel="noreferrer">
                Video {i + 1}
              </a>
            </li>
          ))}
        </ul>
        <button className="bg-blue-600 text-white px-4 py-1 rounded" onClick={() => setVideoUrls(null)}>
          Close
        </button>
      </div>
    </div>
  );

  /* ---------- render ---------- */
  if (!loggedIn) {
    return (
      <div className="flex items-center justify-center h-screen bg-gray-50">
        <div className="bg-white p-8 rounded shadow max-w-sm w-full text-center">
          <h2 className="text-2xl font-semibold mb-4">CEORater Admin</h2>
          <p className="mb-6 text-gray-600">Log in with your Google account.</p>
          <button
            className="bg-blue-600 text-white px-4 py-2 rounded"
            onClick={() => (window.location.href = apiUrl("/admin/auth/google"))}
          >
            Log In with Google
          </button>
          {error && <p className="text-red-500 mt-4 text-sm">{error}</p>}
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 max-w-full overflow-x-auto">
      {/* header */}
      <div className="flex justify-between items-center mb-4">
        <h1 className="text-2xl font-bold">CEORater • Admin Dashboard</h1>
        <button className="text-red-600" onClick={handleLogout}>Logout</button>
      </div>

      {error && <div className="mb-4 p-2 bg-red-100 text-red-700 rounded">{error}</div>}

      <button className="mb-4 bg-green-600 text-white px-3 py-1 rounded" onClick={beginAddRow}>
        + Add New CEO
      </button>

      <table className="min-w-full text-sm border">
        <thead className="bg-gray-100">
          <tr>
            {[
              "CEO Name",
              "Company",
              "Ticker",
              "Founder",
              "Tenure",
              "Return",
              "Comp ($MM)",
              "Equity URL",
              "Price @ Start",
              "Current Price",
              "YouTube",
              "Actions",
            ].map((h) => (
              <th key={h} className="px-2 py-1 border">
                {h}
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {ceos.map((c) => (
            <CeoRow key={c.id || c.ticker || c.ceo_name} ceo={c} />
          ))}
        </tbody>
      </table>

      {videoUrls && <VideoModal urls={videoUrls} />}
    </div>
  );
}
